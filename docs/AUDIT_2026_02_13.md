# Sparebox Security & Code Quality Audit Report

**Audit Date:** February 13, 2026  
**Previous Audit:** February 6, 2026  
**Auditor:** Claw Clawioff ğŸ¦ (AI Assistant)  
**Application:** Sparebox â€” P2P AI Agent Hosting Marketplace  
**Stack:** Next.js 16 + better-auth + tRPC 11 + Drizzle ORM + Supabase Postgres + Stripe + Upstash Redis  
**Files Reviewed:** 85+ source files (every `.ts`, `.tsx`, `.json`, `.md` in the project)

---

## Executive Summary

Compared to the Feb 6 audit, several critical issues have been remediated:
- âœ… Rate limiting on auth endpoints (implemented in `proxy.ts`)
- âœ… `hosts.create` now uses `hostProcedure` (was `protectedProcedure`)
- âœ… `agents.create` now uses `adminProcedure` (was `protectedProcedure`)
- âœ… Subscription cancellation now stops agents (webhook handler fixed)
- âœ… Host deletion checks for active agents
- âœ… Security headers added to `next.config.ts`
- âœ… `robots.ts` now disallows `/dashboard/` and `/api/`
- âœ… Role escalation prevented with `setInitialRole` (only when role = "default")
- âœ… Idempotency in webhook uses transaction + double-check pattern
- âœ… Billing page wired to real subscription data
- âœ… Constants centralized in `constants.ts`

**Remaining issues are lower severity but still need attention before production launch.**

### Issue Counts

| Severity | Count | Change from Feb 6 |
|----------|-------|--------------------|
| ğŸ”´ Critical | 2 | â†“ from 4 |
| ğŸŸ  High | 5 | â†“ from 5 |
| ğŸŸ¡ Medium | 10 | â†‘ from 7 (more thorough review) |
| ğŸ”µ Low | 12 | â†‘ from 7 (more thorough review) |
| âœ… Positive | 18 | â†‘ from 9 |

**Overall Risk Rating:** MEDIUM (down from MEDIUM-HIGH)

---

## Table of Contents

1. [Critical Issues](#1-critical-issues)
2. [High Priority Issues](#2-high-priority-issues)
3. [Medium Priority Issues](#3-medium-priority-issues)
4. [Low Priority Issues](#4-low-priority-issues)
5. [Code Quality Findings](#5-code-quality-findings)
6. [Performance Findings](#6-performance-findings)
7. [Positive Findings](#7-positive-findings)
8. [Comparison with Feb 6 Audit](#8-comparison-with-feb-6-audit)
9. [Prioritized Action Plan](#9-prioritized-action-plan)

---

## 1. Critical Issues

### 1.1 ğŸ”´ API Key Comparison Not Timing-Safe
**Severity:** CRITICAL  
**File:** `src/app/api/hosts/heartbeat/route.ts` (line ~80)  
**Description:** The heartbeat endpoint authenticates daemon requests by hashing the provided API key with SHA-256 and looking it up in the database. While the hash lookup itself is done via SQL `eq()` (which is constant-time at the database level), the overall approach has a subtlety: if an attacker can observe timing differences between "key not found" vs "key found but expired" vs "key found and valid", they could distinguish valid key hashes from invalid ones.

More critically, there is **no use of `crypto.timingSafeEqual()`** anywhere in the codebase for comparing secrets. The current SHA-256 hash-then-lookup pattern is acceptable for API keys, but the cron endpoint uses a **direct string comparison**:

```typescript
// src/app/api/cron/check-hosts/route.ts
if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
```

This is vulnerable to timing attacks on the `CRON_SECRET`.

**Recommendation:**
```typescript
import { timingSafeEqual } from "crypto";

function safeCompare(a: string, b: string): boolean {
  if (a.length !== b.length) return false;
  return timingSafeEqual(Buffer.from(a), Buffer.from(b));
}

// Usage:
const expected = `Bearer ${process.env.CRON_SECRET}`;
if (!authHeader || !safeCompare(authHeader, expected)) {
  return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
}
```

---

### 1.2 ğŸ”´ Missing Database Indexes on Frequently Queried Columns
**Severity:** CRITICAL  
**File:** `src/db/schema.ts`  
**Description:** Despite being flagged in the Feb 6 audit, **no database indexes have been added**. The schema has zero custom indexes. As data grows, these queries will cause full table scans:

| Table | Column(s) | Used In | Impact |
|-------|-----------|---------|--------|
| `agents` | `userId` | `agents.list`, dashboard queries | Every agent list query scans all agents |
| `hosts` | `userId` | `hosts.list`, dashboard queries | Every host list query scans all hosts |
| `hosts` | `status` | `hosts.listAvailable`, cron job | Browse page and cron scan all hosts |
| `subscriptions` | `stripeSubscriptionId` | Webhook handlers | Every Stripe webhook scans all subs |
| `subscriptions` | `userId` | `billing.getMySubscriptions` | Billing page scans all subs |
| `subscriptions` | `hostId` | `hosts.getStats` | Stats queries scan all subs |
| `hostApiKeys` | `keyHash` | Heartbeat auth | Every heartbeat scans all keys |
| `hostApiKeys` | `hostId` + `revokedAt` | Key lookup | Combined query has no index |
| `hostHeartbeats` | `hostId` + `createdAt` | Metrics queries | Metrics page scans all heartbeats |
| `userPreferences` | `userId` | Already has UNIQUE | âœ… OK |

**Recommendation:** Add a migration with indexes:
```typescript
import { index, uniqueIndex } from "drizzle-orm/pg-core";

// On agents table
export const agentsUserIdIdx = index("idx_agents_user_id").on(agents.userId);

// On hosts table  
export const hostsUserIdIdx = index("idx_hosts_user_id").on(hosts.userId);
export const hostsStatusIdx = index("idx_hosts_status").on(hosts.status);

// On subscriptions table
export const subsStripeIdIdx = uniqueIndex("idx_subs_stripe_sub_id").on(subscriptions.stripeSubscriptionId);
export const subsUserIdIdx = index("idx_subs_user_id").on(subscriptions.userId);
export const subsHostIdIdx = index("idx_subs_host_id").on(subscriptions.hostId);

// On hostApiKeys table
export const apiKeysHashIdx = index("idx_api_keys_hash").on(hostApiKeys.keyHash);
export const apiKeysHostIdx = index("idx_api_keys_host_revoked").on(hostApiKeys.hostId, hostApiKeys.revokedAt);

// On hostHeartbeats table
export const heartbeatsHostIdx = index("idx_heartbeats_host_created").on(hostHeartbeats.hostId, hostHeartbeats.createdAt);
```

---

## 2. High Priority Issues

### 2.1 ğŸŸ  Heartbeat Endpoint Doesn't Verify Host Existence or Status
**Severity:** HIGH  
**File:** `src/app/api/hosts/heartbeat/route.ts` (line ~130)  
**Description:** The heartbeat endpoint only verifies the API key, then blindly updates the host to `status: "active"`. It does not check:
1. Whether the host record still exists (could have been deleted)
2. Whether the host is `suspended` (admin action should not be overridden by heartbeat)

A suspended host's daemon could keep sending heartbeats and re-activate itself.

**Recommendation:**
```typescript
// Only re-activate if status is "pending" or "inactive", not "suspended"
await db.update(hosts)
  .set({ lastHeartbeat: new Date(), daemonVersion: data.daemonVersion, ... })
  .where(
    and(
      eq(hosts.id, keyRecord.hostId),
      not(eq(hosts.status, "suspended"))
    )
  );

// Separately set active only for non-suspended hosts
await db.update(hosts)
  .set({ status: "active" })
  .where(
    and(
      eq(hosts.id, keyRecord.hostId),
      eq(hosts.status, "inactive"),  // or "pending"
    )
  );
```

---

### 2.2 ğŸŸ  No Rate Limiting on Waitlist, Avatar Upload, or tRPC Endpoints
**Severity:** HIGH  
**Files:** `src/server/api/routers/waitlist.ts`, `src/app/api/avatar/route.ts`, `src/app/api/trpc/[trpc]/route.ts`  
**Description:** While auth endpoints have rate limiting (via `proxy.ts`), these endpoints do not:

- **Waitlist `join`** â€” Public endpoint, no rate limit. An attacker could flood the waitlist table.
- **Avatar upload** â€” Authenticated but no rate limit. An attacker could exhaust Supabase storage.
- **tRPC endpoints** â€” No per-endpoint rate limiting. Mutations like `billing.createCheckoutSession` could be called repeatedly.

**Recommendation:**
- Add Upstash rate limiting to the waitlist mutation (e.g., 5 per minute per IP)
- Add rate limiting to avatar upload (e.g., 10 per hour per user)
- Consider adding rate limiting middleware to tRPC `protectedProcedure` (e.g., 60 requests/minute)

---

### 2.3 ğŸŸ  Vercel Cron Schedule Is Once Per Day, Not Every 5 Minutes
**Severity:** HIGH  
**File:** `vercel.json`  
**Description:** The code comment in `src/app/api/cron/check-hosts/route.ts` says "runs every 5 minutes", but `vercel.json` configures it as:
```json
{ "schedule": "0 5 * * *" }
```
This is **once per day at 5:00 AM UTC**, not every 5 minutes. Stale hosts will remain "active" for up to 24 hours.

**Recommendation:**
```json
{ "schedule": "*/5 * * * *" }
```
Note: Vercel Pro plan supports cron intervals as low as every minute. Free plan may have limitations â€” verify your plan supports this.

---

### 2.4 ğŸŸ  Agent Deletion Doesn't Cancel Stripe Subscription
**Severity:** HIGH  
**File:** `src/server/api/routers/agents.ts` (delete mutation, line ~120)  
**Description:** When a user deletes an agent, the code deletes the subscription record and agent from the database, but **does not cancel the Stripe subscription**. The user continues to be billed monthly.

```typescript
// Current code - just deletes DB records
await ctx.db.delete(subscriptions).where(eq(subscriptions.agentId, input.id));
await ctx.db.delete(agents).where(eq(agents.id, input.id));
```

**Recommendation:**
```typescript
// Cancel Stripe subscription first
const agentSubs = await ctx.db.query.subscriptions.findMany({
  where: eq(subscriptions.agentId, input.id),
});

for (const sub of agentSubs) {
  if (sub.stripeSubscriptionId && sub.status === "active") {
    await getStripe().subscriptions.cancel(sub.stripeSubscriptionId);
  }
}

// Then delete records
await ctx.db.delete(subscriptions).where(eq(subscriptions.agentId, input.id));
await ctx.db.delete(agents).where(eq(agents.id, input.id));
```

---

### 2.5 ğŸŸ  No Duplicate Agent Name Prevention Per User
**Severity:** HIGH  
**File:** `src/db/schema.ts`, `src/app/api/stripe/webhooks/route.ts`  
**Description:** Users can create multiple agents with the same name. The webhook handler creates agents from Stripe checkout metadata without checking for name conflicts. This could cause confusion in the daemon when agents are referenced by name.

**Recommendation:** Add a unique index on `(userId, name)` to the agents table:
```typescript
export const agentUserNameIdx = uniqueIndex("idx_agents_user_name").on(agents.userId, agents.name);
```

---

## 3. Medium Priority Issues

### 3.1 ğŸŸ¡ No Content-Security-Policy Header
**Severity:** MEDIUM  
**File:** `next.config.ts`  
**Description:** Security headers are present (`X-Content-Type-Options`, `X-Frame-Options`, `HSTS`, `Referrer-Policy`, `Permissions-Policy`), but **no Content-Security-Policy (CSP)** header. This leaves the app vulnerable to XSS via injected scripts.

**Recommendation:**
```typescript
{
  key: "Content-Security-Policy",
  value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' https://api.stripe.com https://*.supabase.co https://www.sparebox.dev; frame-src https://js.stripe.com https://hooks.stripe.com;"
}
```

---

### 3.2 ğŸŸ¡ Lazy Staleness Check Uses Fire-and-Forget DB Updates
**Severity:** MEDIUM  
**Files:** `src/server/api/routers/hosts.ts` (lines ~56, ~175)  
**Description:** The `hosts.get` and `hosts.listAvailable` procedures fire-and-forget database updates:
```typescript
ctx.db.update(hosts)
  .set({ status: "inactive", updatedAt: new Date() })
  .where(eq(hosts.id, host.id))
  .then(() => {})
  .catch(() => {});
```

This has several problems:
1. Silent failure â€” if the update fails, nobody knows
2. Race condition â€” concurrent requests could conflict
3. The `.then(() => {}).catch(() => {})` pattern swallows all errors

**Recommendation:** Either await the update (it's fast) or log errors:
```typescript
ctx.db.update(hosts)
  .set({ status: "inactive", updatedAt: new Date() })
  .where(eq(hosts.id, host.id))
  .catch(err => console.error("[Staleness] Failed to mark host inactive:", err));
```

---

### 3.3 ğŸŸ¡ `hosts.update` Uses `protectedProcedure` Instead of `hostProcedure`
**Severity:** MEDIUM  
**File:** `src/server/api/routers/hosts.ts` (line ~88)  
**Description:** While `hosts.create` and `hosts.delete` correctly use `hostProcedure`, the `hosts.update` mutation uses `protectedProcedure`. This means any authenticated user (including deployers) could update a host if they knew the host ID. The ownership check mitigates this partially, but role enforcement is missing.

**Recommendation:** Change to `hostProcedure`.

---

### 3.4 ğŸŸ¡ `hosts.get`, `hosts.getStats`, `hosts.getMetrics` Throw Generic `Error`
**Severity:** MEDIUM  
**File:** `src/server/api/routers/hosts.ts` (multiple locations)  
**Description:** Several procedures throw `new Error("Host not found")` instead of `TRPCError`. This results in a 500 INTERNAL_SERVER_ERROR instead of a proper 404 NOT_FOUND response.

```typescript
// Bad
throw new Error("Host not found");

// Good
throw new TRPCError({ code: "NOT_FOUND", message: "Host not found" });
```

**Locations:**
- `hosts.get` â€” line ~58
- `hosts.update` â€” line ~100
- `hosts.getStats` â€” line ~198
- `hosts.getMetrics` â€” line ~228

---

### 3.5 ğŸŸ¡ JSON-LD Uses `dangerouslySetInnerHTML`
**Severity:** MEDIUM  
**File:** `src/app/blog/[slug]/page.tsx`  
**Description:** The JSON-LD structured data uses `dangerouslySetInnerHTML`:
```tsx
<script
  type="application/ld+json"
  dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
/>
```
While the data comes from MDX frontmatter (trusted), if blog authoring is ever opened up, this becomes an XSS vector. The `JSON.stringify` call doesn't escape HTML entities like `</script>`.

**Recommendation:** Use the Next.js metadata API or sanitize:
```typescript
JSON.stringify(jsonLd).replace(/</g, '\\u003c')
```

---

### 3.6 ğŸŸ¡ No CSRF Token Validation on Password Change/Account Delete
**Severity:** MEDIUM  
**File:** `src/app/dashboard/settings/page.tsx`  
**Description:** Password change and account deletion use direct `fetch()` to better-auth endpoints:
```typescript
await fetch("/api/auth/change-password", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ currentPassword, newPassword, revokeOtherSessions: true }),
});
```

better-auth handles CSRF via its `trustedOrigins` config, which does check the `Origin` header. However, the `trustedOrigins` config includes both `sparebox.dev` and `www.sparebox.dev` â€” an attacker on a subdomain could potentially bypass this.

**Recommendation:** Ensure cookies are set with `SameSite=Lax` or `Strict`. Verify better-auth's CSRF protection is enabled (it is by default with `trustedOrigins`).

---

### 3.7 ğŸŸ¡ Signup Race Condition Between Account Creation and Role Setting
**Severity:** MEDIUM  
**File:** `src/app/(auth)/signup/page.tsx` (line ~55)  
**Description:** After `signUp.email()`, there's a 500ms `setTimeout` before calling `setInitialRole`:
```typescript
await signUp.email({ email, password, name });
await new Promise(resolve => setTimeout(resolve, 500));
await setRoleMutation.mutateAsync({ role });
```

This is fragile â€” if the delay isn't enough, the role mutation will fail because the session isn't established yet. If it fails, the comment says "Continue anyway" and the user lands on dashboard with `default` role, which redirects to onboarding. But the `setInitialRole` call already used up the one-time role set attempt.

**Recommendation:** Instead of a fixed delay, retry the role mutation with exponential backoff, or handle it server-side in the signup flow.

---

### 3.8 ğŸŸ¡ Stripe Webhook Error Handler Returns 200 on Processing Failures
**Severity:** MEDIUM  
**File:** `src/app/api/stripe/webhooks/route.ts` (line ~80)  
**Description:** When event processing fails, the code returns `200` to prevent Stripe retries:
```typescript
return NextResponse.json({ received: true, error: message }, { status: 200 });
```

While this prevents Stripe from disabling the endpoint, it means **failed events are silently lost**. If `handleCheckoutCompleted` fails (e.g., database down), the agent never gets created and the user is charged but gets nothing.

**Recommendation:** Return 500 for retryable errors (DB failures), 200 only for non-retryable ones (invalid metadata). Implement an idempotency-safe retry strategy.

---

### 3.9 ğŸŸ¡ No Heartbeat Data Retention/Cleanup
**Severity:** MEDIUM  
**File:** `src/db/schema.ts` (hostHeartbeats table)  
**Description:** The `hostHeartbeats` table accumulates a row every 60 seconds per host (1,440 rows/host/day, ~43,800/host/month). There is no cleanup mechanism â€” no TTL, no cron to delete old heartbeats, no partitioning. This will cause unbounded table growth.

**Recommendation:** Add a cron job to delete heartbeats older than 7 days, or use Postgres partitioning on `createdAt`.

---

### 3.10 ğŸŸ¡ Avatar Upload Doesn't Validate File Content (Only MIME Type)
**Severity:** MEDIUM  
**File:** `src/app/api/avatar/route.ts`  
**Description:** The avatar upload checks `file.type` (MIME type from the client), but doesn't verify the actual file content matches. An attacker could upload a malicious file with a spoofed MIME type.

**Recommendation:** Validate the file's magic bytes:
```typescript
const buffer = Buffer.from(await file.arrayBuffer());
const magicBytes = buffer.subarray(0, 4);
const isJpeg = magicBytes[0] === 0xFF && magicBytes[1] === 0xD8;
const isPng = magicBytes[0] === 0x89 && magicBytes[1] === 0x50;
// etc.
```

---

## 4. Low Priority Issues

### 4.1 ğŸ”µ 53 Console.log/Console.error Statements in API Routes
**Severity:** LOW  
**Files:** `src/app/api/stripe/webhooks/route.ts`, `src/server/auth/index.ts`, and others  
**Description:** There are 53 `console.log`/`console.error` statements in API routes and server code. In production on Vercel, these go to Vercel Logs, but there's no structured logging, log levels, or correlation IDs.

**Recommendation:** Consider a structured logger (e.g., `pino`) that outputs JSON with request IDs.

---

### 4.2 ğŸ”µ No Error Boundary Files
**Severity:** LOW  
**Files:** `src/app/` (missing `error.tsx` everywhere)  
**Description:** Zero `error.tsx` files exist in the entire app. If any server component throws, the user sees Next.js's default error page with no recovery option.

**Recommendation:** Add at minimum:
- `src/app/error.tsx` (root error boundary)
- `src/app/dashboard/error.tsx` (dashboard error boundary)

---

### 4.3 ğŸ”µ No Loading State Files
**Severity:** LOW  
**Files:** `src/app/` (missing `loading.tsx` everywhere)  
**Description:** Zero `loading.tsx` files exist. Route transitions show no visual feedback.

**Recommendation:** Add loading skeletons for dashboard routes.

---

### 4.4 ğŸ”µ Extensive Use of `as any` Type Casts (30+ instances)
**Severity:** LOW  
**Files:** Multiple dashboard pages  
**Description:** 30+ instances of `(x as any)` scattered across components. Most are for accessing relational data returned by tRPC:
```typescript
(agent as any).host?.name  // agents/page.tsx
(host as any).specsVerified  // hosts/[hostId]/page.tsx
```

This suggests the tRPC return types don't include relational fields properly.

**Recommendation:** Fix the tRPC router return types to include `with:` relations in the type, or create proper TypeScript interfaces for the response shapes.

---

### 4.5 ğŸ”µ User Dashboard Shows Hardcoded "99.9%" Uptime
**Severity:** LOW  
**File:** `src/components/user-dashboard.tsx` (line ~23)  
**Description:** The user dashboard overview still shows a hardcoded "99.9%" average uptime stat card. This is misleading.

**Recommendation:** Calculate from actual agent data or remove the stat card.

---

### 4.6 ğŸ”µ Agent Config Rendered Without Sanitization
**Severity:** LOW  
**File:** `src/app/dashboard/agents/[id]/page.tsx` (config tab)  
**Description:** The agent's `config` field is rendered inside a `<pre>` tag:
```tsx
<pre>{agent.config || `# openclaw.yaml\n...`}</pre>
```

While `<pre>` auto-escapes HTML in React, this config could contain sensitive data (API keys) that users stored in their config. There's no warning about this.

**Recommendation:** Add a security notice about not storing secrets in the config field directly.

---

### 4.7 ğŸ”µ Install Script Uses `curl | bash` Pattern
**Severity:** LOW  
**File:** `src/app/api/install/route.ts`  
**Description:** The daemon install instruction is `curl -fsSL ... | bash`. While common in the industry, this is a well-known security concern â€” if the HTTPS connection is MITM'd or the CDN is compromised, arbitrary code runs.

**Recommendation:** Document SHA-256 checksum verification as an alternative:
```bash
curl -fsSL https://www.sparebox.dev/api/install -o install.sh
sha256sum install.sh  # verify against published hash
bash install.sh
```

---

### 4.8 ğŸ”µ Windows Install Script Is Incomplete
**Severity:** LOW  
**File:** `src/app/api/install/windows/route.ts`  
**Description:** The Windows PowerShell install script tells users to `git clone` and build from source instead of downloading the pre-built daemon bundle. This is inconsistent with the Linux installer.

**Recommendation:** Update to download `sparebox-daemon.cjs` directly, same as the Linux script.

---

### 4.9 ğŸ”µ `strictRatelimit` in `rate-limit.ts` Is Never Used
**Severity:** LOW  
**File:** `src/lib/rate-limit.ts`  
**Description:** The `getStrictRatelimit()` function is defined but never imported or called anywhere.

**Recommendation:** Either use it for the password-reset endpoint or remove it to reduce dead code.

---

### 4.10 ğŸ”µ Terms of Service Link Points to `/terms` But Page Is at `/terms-of-service`
**Severity:** LOW  
**File:** `src/app/dashboard/agents/new/page.tsx`  
**Description:** The deploy agent page links to `/terms`:
```tsx
<Link href="/terms" className="text-primary hover:underline">Terms of Service</Link>
```
But the actual page is at `/terms-of-service`. This is a 404 link.

**Recommendation:** Change to `/terms-of-service`.

---

### 4.11 ğŸ”µ IP Address for Geo-lookup Uses External Service Without Fallback
**Severity:** LOW  
**File:** `src/app/api/hosts/heartbeat/route.ts` (line ~160)  
**Description:** The heartbeat handler calls `https://ipapi.co/{ip}/json/` for geolocation. This external service:
1. Has rate limits (free tier: 30k/month)
2. Could leak host IP addresses to a third party
3. Is a single point of failure

The failure is handled gracefully (non-critical), but the privacy concern remains.

**Recommendation:** Consider using Vercel's built-in `request.geo` or Cloudflare headers instead.

---

### 4.12 ğŸ”µ Session Token Exposed in `getSession` Return
**Severity:** LOW  
**File:** `src/lib/auth/session.ts` (line ~52)  
**Description:** The `getSession()` function returns `session.token` in its response:
```typescript
session: {
  token: result.session.token,
  ...
}
```
This session token is then available to any server component that calls `getSession()`. While it's server-side only, it increases the attack surface if the session object is accidentally serialized to the client.

**Recommendation:** Omit `token` from the returned session unless explicitly needed.

---

## 5. Code Quality Findings

### 5.1 TypeScript Strictness
- **`strict: true`** is enabled in `tsconfig.json` âœ…
- **30+ `as any` casts** in dashboard components â€” mostly for tRPC relation data
- **Stripe webhook types** use `any` extensively for event data objects
- **No `@typescript-eslint/no-explicit-any` rule** â€” `any` is not enforced

### 5.2 Error Handling Patterns
- tRPC routers: Mix of `TRPCError` (correct) and `new Error()` (incorrect)
- Webhook handlers: `try/catch` with console.error (adequate for now)
- Client components: Proper error states with user-friendly messages âœ…
- Missing error boundaries in all route groups

### 5.3 File Organization
- Clean separation: `/server`, `/lib`, `/db`, `/components`, `/app` âœ…
- tRPC routers well-organized by domain âœ…
- Email templates properly separated âœ…
- **Missing:** `/types` directory for shared type definitions
- **Missing:** `/hooks` directory (no custom hooks yet)

### 5.4 Naming Conventions
- Files: kebab-case âœ…
- Components: PascalCase âœ…
- Variables/functions: camelCase âœ…
- Database tables: mix of singular (`user`, `session`) and plural (`hosts`, `agents`) â€” this is due to better-auth requiring singular for its tables

### 5.5 Dead Code
| File | Dead Code | Type |
|------|-----------|------|
| `src/lib/rate-limit.ts` | `getStrictRatelimit()` | Never imported |
| `src/lib/auth/index.ts` | Re-exports `useSession` | Server module re-exporting client hook (could cause issues) |
| `src/lib/theme.ts` | `tw` export | Appears unused in component code |
| `daemon/bundle.js` | Entire file | Built artifact committed to repo |

### 5.6 Import Patterns
- Consistent use of `@/` path aliases âœ…
- No circular imports detected âœ…
- Some unnecessary re-exports in `src/lib/auth/index.ts` (mixes server/client)

---

## 6. Performance Findings

### 6.1 N+1 Query in `hosts.listAvailable`
**File:** `src/server/api/routers/hosts.ts`  
**Description:** The lazy staleness check fires a separate `UPDATE` query for each stale host found:
```typescript
for (const host of results) {
  if (stale) {
    ctx.db.update(hosts).set({ status: "inactive" }).where(eq(hosts.id, host.id));
  }
}
```
With many stale hosts, this becomes N individual UPDATE queries.

**Recommendation:** Batch the staleness update into a single query (already done in the cron job â€” could remove the lazy check entirely since the cron handles it).

### 6.2 Heartbeat Inserts Without Cleanup
**File:** `src/app/api/hosts/heartbeat/route.ts`  
**Description:** Every heartbeat creates a new row in `hostHeartbeats` (every 60s per host). No TTL or cleanup. This will cause:
- Unbounded table growth (~1.3M rows/host/year)
- Slow metrics queries without proper indexes
- Increased storage costs

### 6.3 `getSession()` Makes Two Database Calls
**File:** `src/lib/auth/session.ts`  
**Description:** Every `getSession()` call:
1. Calls `auth.api.getSession()` (which queries the session/user tables)
2. Then queries the user table *again* to get the role

This double-query happens on every authenticated page load.

**Recommendation:** Configure better-auth to include `role` in the session response (via `additionalFields`, which is already configured â€” verify it works and remove the extra query).

### 6.4 Dashboard Layout Calls `requireAuth()` on Every Navigation
**File:** `src/app/dashboard/layout.tsx`  
**Description:** The dashboard layout calls `requireAuth()` â†’ `getSession()` on every page navigation within the dashboard. This is 2 DB queries per navigation. Consider caching the session in the request scope.

### 6.5 Middleware Dynamic Import
**File:** `src/proxy.ts`  
**Description:** The rate limiter uses dynamic `import()` inside the middleware:
```typescript
const { Ratelimit } = await import("@upstash/ratelimit");
const { Redis } = await import("@upstash/redis");
```
This adds latency to every auth request. The modules should be statically imported.

**Note:** This might have been done intentionally to keep the middleware compatible with Edge Runtime, where some modules may not be available. Verify this is needed.

---

## 7. Positive Findings

### âœ… Authentication & Authorization
1. **better-auth properly configured** with email/password + GitHub + Google OAuth
2. **Role-based access control** well-implemented via tRPC middleware (`hostProcedure`, `userProcedure`, `adminProcedure`)
3. **Admin role bypass** consistently applied across all role checks
4. **`setInitialRole` is one-time only** â€” uses atomic `WHERE role = 'default'` check
5. **Email verification flow** properly implemented with Resend
6. **Password reset** doesn't reveal email existence (timing-safe UX)
7. **Session expiry** configured (7 days, refresh after 1 day)
8. **`trustedOrigins`** configured for CSRF protection

### âœ… API Security
9. **Stripe webhook signature verification** properly implemented for both main and Connect webhooks
10. **API keys properly hashed** with SHA-256, only hash stored, raw key shown once
11. **Heartbeat endpoint** has rate limiting, Zod validation, API key auth
12. **Cron endpoint** requires `CRON_SECRET` bearer token
13. **Input validation** with Zod on all tRPC mutations and heartbeat endpoint

### âœ… Data Protection
14. **No secrets in `NEXT_PUBLIC_` env vars** â€” only `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_APP_URL`
15. **Database credentials not in code** â€” uses `process.env.DATABASE_URL`
16. **Cascade deletes** properly configured on all foreign keys
17. **File upload validation** â€” size limit (5MB), type checking, proper error handling

### âœ… Code Quality
18. **TypeScript strict mode enabled**
19. **Consistent tRPC patterns** across all routers
20. **Clean component architecture** with proper separation
21. **Well-documented code** â€” JSDoc comments on guards, session utils, tRPC procedures
22. **Daemon code** is clean, zero-dependency, with proper error handling and backoff

---

## 8. Comparison with Feb 6 Audit

| Feb 6 Issue | Status | Notes |
|-------------|--------|-------|
| 1.1 No rate limiting on auth | âœ… **FIXED** | Implemented in `proxy.ts` with Upstash |
| 1.2 `hosts.create` uses `protectedProcedure` | âœ… **FIXED** | Now uses `hostProcedure` |
| 1.3 `agents.create` bypasses payment | âœ… **FIXED** | Now uses `adminProcedure` |
| 1.4 Database credentials in `.env.local` | âš ï¸ **PARTIAL** | Can't verify rotation, but .env.local is gitignored |
| 2.1 No idempotency on webhook | âœ… **FIXED** | Transaction + double-check pattern |
| 2.2 Role change security flaw | âœ… **FIXED** | Replaced `setRole` with `setInitialRole` (one-time only) |
| 2.3 Subscription cancel doesn't stop agent | âœ… **FIXED** | Webhook now stops agent |
| 2.4 Missing database indexes | ğŸ”´ **NOT FIXED** | Still no indexes |
| 2.5 No duplicate agent name prevention | ğŸŸ  **NOT FIXED** | Still no unique constraint |
| 3.1 Inconsistent TRPCError codes | ğŸŸ¡ **PARTIAL** | Some fixed, `hosts.get/update/getStats/getMetrics` still use `new Error()` |
| 3.2 Billing page not wired | âœ… **FIXED** | `getMySubscriptions` implemented |
| 3.3 Host deletion with active agents | âœ… **FIXED** | Now checks and rejects |
| 3.4 No CSRF on password change | ğŸŸ¡ **PARTIAL** | better-auth's `trustedOrigins` provides baseline protection |
| 3.5 No security headers | âœ… **FIXED** | Added to `next.config.ts` |
| 3.6 JSON-LD `dangerouslySetInnerHTML` | ğŸŸ¡ **NOT FIXED** | Still present |
| 3.7 Agent details hardcoded data | âœ… **FIXED** | Now uses real subscription data |
| 4.1 Unused import in users.ts | âœ… **FIXED** | `publicProcedure` no longer imported |
| 4.2 Console.log in production | ğŸ”µ **NOT FIXED** | 53 statements remain |
| 4.3 Magic numbers | âœ… **FIXED** | `PLATFORM_FEE_PERCENT` in constants |
| 4.4 Missing error boundaries | ğŸ”µ **NOT FIXED** | Zero error.tsx files |
| 4.5 No loading states | ğŸ”µ **NOT FIXED** | Zero loading.tsx files |
| 4.6 Sitemap/robots | âœ… **FIXED** | robots.ts disallows `/dashboard/` and `/api/` |
| 4.7 Missing Terms of Service | âš ï¸ **PARTIAL** | Page exists at `/terms-of-service` but link in deploy page points to `/terms` |

---

## 9. Prioritized Action Plan

### Tier 1: Before Any Real Users (Critical)
1. **Add database indexes** â€” [Critical Â§1.2] â€” Single migration, huge impact
2. **Fix cron schedule** â€” [High Â§2.3] â€” One-line change in `vercel.json`
3. **Cancel Stripe subscription on agent delete** â€” [High Â§2.4] â€” Prevents billing users for deleted agents
4. **Use timing-safe comparison for cron secret** â€” [Critical Â§1.1] â€” Quick fix

### Tier 2: Before Beta Launch (High)
5. **Prevent heartbeat from overriding `suspended` status** â€” [High Â§2.1]
6. **Add rate limiting to waitlist/avatar/tRPC** â€” [High Â§2.2]
7. **Add unique constraint on agent names per user** â€” [High Â§2.5]
8. **Add Content-Security-Policy header** â€” [Medium Â§3.1]
9. **Fix Terms of Service link** â€” [Low Â§4.10] â€” Quick fix
10. **Add heartbeat data retention cron** â€” [Medium Â§3.9]

### Tier 3: Before Production Launch (Medium)
11. **Fix all `throw new Error()` to `throw new TRPCError()`** â€” [Medium Â§3.4]
12. **Fix signup race condition** â€” [Medium Â§3.7]
13. **Validate avatar file content (magic bytes)** â€” [Medium Â§3.10]
14. **Fix lazy staleness fire-and-forget pattern** â€” [Medium Â§3.2]
15. **Change `hosts.update` to `hostProcedure`** â€” [Medium Â§3.3]
16. **Add error.tsx boundary files** â€” [Low Â§4.2]
17. **Add loading.tsx files** â€” [Low Â§4.3]

### Tier 4: Quality Improvements (Low)
18. **Remove `as any` casts** by improving tRPC types â€” [Low Â§4.4]
19. **Implement structured logging** â€” [Low Â§4.1]
20. **Remove dead code** (`getStrictRatelimit`, `daemon/bundle.js`) â€” [Low Â§4.9]
21. **Fix Windows install script** â€” [Low Â§4.8]
22. **Optimize `getSession()` to single query** â€” [Performance Â§6.3]
23. **Remove session token from `getSession` return** â€” [Low Â§4.12]
24. **Add SHA-256 verification for daemon download** â€” [Low Â§4.7]

---

*Report generated from comprehensive file-by-file review of all 85+ source files in the Sparebox project. Every TypeScript, TSX, JSON, and configuration file was read and analyzed.*
